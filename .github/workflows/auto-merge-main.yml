name: Auto Merge to Main on Tag

on:
  push:
    tags:
      - 'v*'
    branches:
      - dev

jobs:
  merge-to-main:
    if: github.ref_type == 'tag' || contains(github.event.head_commit.message, 'v0.') || contains(github.event.head_commit.message, 'v1.')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: dev

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch all branches and tags
        run: |
          git fetch --all
          git fetch --tags

      - name: Merge dev to main
        run: |
          git checkout main
          git pull origin main
          git merge origin/dev -m "chore: Auto-merge dev to main for release ${{ github.ref_name }}"
          git push origin main

      - name: Push tag to main
        if: github.ref_type == 'tag'
        run: |
          git tag -f ${{ github.ref_name }}
          git push origin ${{ github.ref_name }} --force

      - name: Create Pull Request (fallback)
        if: failure()
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'chore: Sync dev to main for release'
          title: 'üîÑ Auto-sync dev ‚Üí main for release ${{ github.ref_name }}'
          body: |
            ## Automated Merge Request
            
            This PR automatically syncs changes from `dev` to `main` branch for release `${{ github.ref_name }}`.
            
            **Triggered by:** Tag push to dev branch
            **Tag:** `${{ github.ref_name }}`
            
            ### ‚ö†Ô∏è Manual Merge Required
            The automatic merge failed due to conflicts. Please review and merge manually.
            
            ---
            *This PR was created automatically by GitHub Actions*
          branch: auto-merge-dev-to-main-${{ github.run_number }}
          base: main
          labels: |
            automated
            merge
